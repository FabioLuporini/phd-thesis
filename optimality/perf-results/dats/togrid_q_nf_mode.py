"""
Generate a grid of plots given raw data generated by pybench
"""
import numpy as np
import matplotlib.pyplot as plt
from mpl_toolkits.axes_grid1 import Grid

import os
import sys
from collections import defaultdict
from ast import literal_eval

names = ['plain', 'ffc-quadrature', 'ffc-tensor', 'ffc-auto', 'uflacs', 'coffee-O1', 'coffee-O4']

plt.style.use('ggplot')

if len(sys.argv) != 3:
    print "Usage: directory-of-FiredrakeFormsCoffee.dat problem-name"
    sys.exit(0)

filename = "%s.dat" % sys.argv[2]

with open(os.path.join(sys.argv[1], filename), "r") as f:
    timings = literal_eval(f.read())['timings']

# First, adjust times in a dictionary as I need
_timings = defaultdict(dict)
for info, vals in sorted(timings.items()):
    q, p, name, opt = info
    if p != q:
        # The point is to have only plots when q=p
        continue
    vals.pop('total')
    for nf, time in vals.items():
        _timings[(nf, q)][opt] = time

# How many subplots am I going to display ?
name = sys.argv[2]
if name in ['mass', 'helmholtz', 'poisson', 'elasticity']:
    nsubplots = (4, 4)
elif name == 'hyperelasticity':
    nsubplots = (2, 4)
else:
    raise RuntimeError("Invalid problem name")

fig = plt.figure()

# Render text through latex

grid = Grid(fig, rect=111, nrows_ncols=nsubplots, axes_pad=0.25, label_mode='L')
for ax, ((nf, q), vals) in zip(grid, sorted(_timings.items())):

    _nf = int(nf[3:])

    plain = vals['plain']
    ffc_quad = vals['ffc-quadrature']
    ffc_tens = vals['ffc-tensor']
    ffc_auto = vals['ffc-auto']
    uflacs = vals['uflacs']
    coffee_O1 = vals['coffee-O1']
    coffee_O4 = vals['coffee-O4']

    # Plot parameters
    # We are going to show the speedup of /ffc_quad/, /ffc_tens/, /ffc_auto/, /uflacs/,
    # /coffee_O1/, /coffee_O4/ over /plain/, so N = 6
    N = 6
    # the x locations for the groups
    ind = np.arange(N)
    # the width of the bars
    width = 0.30
    # the font size
    fontsize = 12

    # Plot
    tick_names = (r'quad', r'tens', r'auto', r'ufls', r'cfO1', r'cfO2')
    offset = 1.03 if name == 'hyperelasticity' else 1.08
    ax.set_title(r'$q = %d$' % q, fontsize=fontsize, y=offset)
    ax.set_xticks(ind + width/2)
    ax.set_xticklabels(tick_names, fontsize=fontsize-5.5)
    ax.grid(axis='x')
    ax.axhline(y=1, color='black', linestyle='--', linewidth=0.75)
    if _nf > 0:
        ax.title.set_visible(False)

    # Compute speed ups
    p = plain
    speedups = (p/ffc_quad, p/ffc_tens, p/ffc_auto, p/uflacs, p/coffee_O1, p/coffee_O4)
    # Draw the bars
    bars = ax.bar(ind, speedups, width, color='black')
    for i, bar in enumerate(bars):
        bar.set_color(plt.rcParams['axes.color_cycle'][i])

    # Tricks to display proper ylabels and axis titles
    if name == 'helmholtz':
        y0 = 42.6
        y1 = 26.73
        ax.set_ylabel(r'$\mathrm{nf} = %d$' % _nf, fontsize=fontsize, color='black', labelpad=9.0)
        ax.set_ylim([0.0, 8.3])
        ax.set_yticks([0, 2, 4, 6, 8])
    elif name == 'elasticity':
        y0 = 64.2
        y1 = 39.0
        ax.set_ylim([0.0, 12.5])
        ax.set_yticks([0, 2, 4, 6, 8, 10, 12])
        ax.set_ylabel(r'$\mathrm{nf} = %d$' % _nf, fontsize=fontsize, color='black', labelpad=3.8)
    elif name == 'mass':
        y0 = 20.48
        y1 = 12.73
        ax.set_ylabel(r'$\mathrm{nf} = %d$' % _nf, fontsize=fontsize, color='black', labelpad=9.0)
        ax.set_ylim([0.0, 4.0])
        ax.set_yticks([0, 1, 2, 3, 4])
    elif name == 'hyperelasticity':
        y0 = 48.0
        y1 = 30.0
        ax.set_ylim([0.0, 21.0])
        ax.set_yticks([0, 5, 10, 15, 20])
        ax.set_ylabel(r'$\mathrm{nf} = %d$' % _nf, fontsize=fontsize, color='black', labelpad=3.8)

# Finally, we're ready to plot !
plt.text(-9.6, y0, r'Polynomial degree $q$')
plt.text(-22.15, y1, r'Speedup relative to baseline', rotation='vertical')
plt.savefig('%s.pdf' % name)
